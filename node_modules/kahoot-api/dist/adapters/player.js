"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_quiz=_interopRequireDefault(require("../quiz")),_adapter=_interopRequireDefault(require("./adapter")),_events=_interopRequireDefault(require("../events")),Player=function(a){function b(a){var c;if((0,_classCallCheck2["default"])(this,b),c=(0,_possibleConstructorReturn2["default"])(this,(0,_getPrototypeOf2["default"])(b).call(this,a)),a.playerBound)throw new Error("Socket can only be used for one player");return c.cid="",c.name="",c.quiz=new _quiz["default"],c.pointsData={},c.loggedIn=!1,c.timeouts=[],c.socket=a,c.socket.playerBound=(0,_assertThisInitialized2["default"])(c),c}return(0,_inherits2["default"])(b,a),(0,_createClass2["default"])(b,[{key:"twoFactorLogin",value:function twoFactorLogin(a){return this.send("/service/controller",{id:_events["default"].submitTwoFactorAuth,type:"message",content:JSON.stringify({sequence:a})})}},{key:"bruteForceTwoFactor",value:function bruteForceTwoFactor(){var a=this,b=["0123","0132","0213","0231","0321","0312","1023","1032","1203","1230","1302","1320","2013","2031","2103","2130","2301","2310","3012","3021","3102","3120","3201","3210"];b.forEach(function(c,d){var e=setTimeout(function(){a.loggedIn||a.twoFactorLogin(c),a.timeouts.splice(a.timeouts.indexOf(e),1)},d*(1e3/b.length));a.timeouts.push(e)})}},{key:"stopBruteForce",value:function stopBruteForce(){var a=this;this.timeouts.forEach(function(b,c){clearTimeout(b),a.timeouts.splice(c,1)})}},{key:"join",value:function join(a){var b=this,c=this.socket.info.twoFactorAuth,d={participantUserId:null,device:{userAgent:"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.75 Safari/537.36",screen:{width:1920,height:1080}}};return new Promise(function(e,f){b.on("controller",function(a){var d=a.data;"loginResponse"===d.type&&(d.error&&f(new Error(d.description)),b.cid=d.cid,!c&&(b.loggedIn=!0,e()))}),c&&b.once("status",function(a){var c=a.data,d=c.status;"ACTIVE"===d?b.on("player",function(a){var c=a.data,d=c.id;d!==_events["default"].resetTwoFactorAuth||b.loggedIn||(b.stopBruteForce(),b.bruteForceTwoFactor()),d===_events["default"].twoFactorAuthCorrect&&(b.loggedIn=!0,b.stopBruteForce(),e()),d===_events["default"].userNameAccepted&&b.bruteForceTwoFactor()}):f(new Error("Status not active: ".concat(d)))}),b.send("/service/controller",{content:JSON.stringify(d),name:a,type:"login",status:"VERIFIED"})}).then(function(){b.name=a}).then(this.initListeners())}},{key:"team",value:function team(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];return this.send("/service/controller",{content:JSON.stringify(a),id:_events["default"].joinTeamMembers,type:"message"})}},{key:"answer",value:function answer(a){return this.send("/service/controller",{content:JSON.stringify({choice:a,questionIndex:0,type:"quiz",meta:{lag:50}}),id:_events["default"].gameBlockAnswer,type:"message"})}},{key:"leave",value:function leave(){var a=this;this.stopBruteForce(),this.socket.playerBound=!1,this.send("/service/controller",{cid:this.cid,type:"left"});var b=new Promise(function(b){return a.socket.disconnect(b)});return b}},{key:"initListeners",value:function initListeners(){var a=this;this.on("player",function(b){var c=b.data,d=c.type;switch(d){case"message":{var e=c.id,f=c.content,g=f?JSON.parse(f):"";a.emit("message",{id:e,content:g});break}default:}}),this.on("message",function(b){switch(b.id){case _events["default"].startQuiz:{var c=b.content.quizName;a.quiz.name=c;break}case _events["default"].getReady:{var d=b.content.questionIndex;a.quiz.questionIndex=d;break}default:}})}}]),b}(_adapter["default"]);exports["default"]=Player;
//# sourceMappingURL=player.js.map