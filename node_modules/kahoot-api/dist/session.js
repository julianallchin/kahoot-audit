"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_cometdNodejsClient=_interopRequireDefault(require("cometd-nodejs-client")),_http=_interopRequireDefault(require("./http")),_helpers=_interopRequireDefault(require("./helpers")),_api=_interopRequireDefault(require("./web/api"));"undefined"==typeof window&&_cometdNodejsClient["default"].adapt();var cometd=require("cometd"),Session=function(){function a(b,c){var d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"https://";(0,_classCallCheck2["default"])(this,a),this.pin=b,this.proxy=c,this.protocol=d,this.web=new _api["default"](c,d)}return(0,_createClass2["default"])(a,[{key:"openSocket",value:function openSocket(){var a=this;return this.check(this.pin).then(function(b){return a.connect(b)})}},{key:"check",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",_http["default"].get("".concat(this.proxy).concat(this.protocol,"kahoot.it/reserve/session/").concat(b,"/?").concat(_helpers["default"].time())).then(function(a){var c=a.data;return c.token=a.headers["x-kahoot-session-token"],c.pin=b,c})["catch"](function(a){if(a.message.includes("404"))throw new Error("Game not found");else throw a}));case 1:case"end":return a.stop();}},a,this)}));return function check(){return a.apply(this,arguments)}}()},{key:"connect",value:function connect(a){var b=this,c=new cometd.CometD,d=_helpers["default"].solve(a.challenge),e=_helpers["default"].shiftBits(a.token,d),f=/[^A-Z,^a-z,^0-9]/g.test(e);if(f)return this.check(a.pin).then(function(a){return b.connect(a)});c.configure({url:"https://kahoot.it/cometd/".concat(a.pin,"/").concat(e)}),c.websocketEnabled=!0;var g=new Promise(function(a){return c.handshake(a)});return g.then(function(b){if(!b.successful)throw new Error("Session failed to connect");return c.info=a,c})}}]),a}();exports["default"]=Session;
//# sourceMappingURL=session.js.map